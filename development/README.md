# OpenEHR Specifications ITS REST – Build, Bundle, Validate, and Generate

This repository contains the OpenAPI (OAS) sources and tooling used to build the openEHR REST API artifacts. 
You author specs under `specifications/` and produce validated YAMLs and rendered documentation under `computable/OAS` and `docs/` via containerized tooling.

It is designed to run entirely via Docker. You do not need local PHP or Node installations; all tools run in containers.
For convenience, a `Makefile` (in `development/`) provides a thin wrapper around the core scripts and containers.

## Repository Structure (what is where)

- **specifications/** — Authoring OpenAPI sources split by domain (overview, system, ehr, query, definition, demographic, admin). Top-level entry points are `<spec>.openapi.yaml`.
- **development/** — All build tooling and scripts live here.
    - `Makefile` — Primary entry point for common tasks (bundle, validate, generate, mock servers, install, clean).
    - `docker-compose.yml` — Defines php and redocly services; swagger-cli is provided via a separate image.
    - `Dockerfile` — Container images for php and swagger-cli.
    - `src/` — PHP transformation code (OpenEHR\Specifications\Tools\OpenAPI\Writer\*).
- **computable/OAS/** — Computed build artifacts (outputs) produced by bundling and transformation.
- **docs/** — Rendered HTML docs for each spec (e.g., `docs/overview.html`).
- **codegen/** — Client/server code generated by the OpenAPI generator scripts/targets.

## What gets generated (outputs)

For each top-level spec (overview|system|ehr|query|definition|demographic|admin) the build produces:

- `computable/OAS/<spec>.openapi.json` — Bundled single-file JSON from the authoring YAML.
- `computable/OAS/<spec>-codegen.openapi.yaml` — Variant tailored for client/server generators.
- `computable/OAS/<spec>-validation.openapi.yaml` — Variant tailored for validation and mock servers (with unused components removed).
- `computable/OAS/<spec>-html.openapi.yaml` — Variant for HTML rendering.
- `docs/<spec>.html` — Rendered HTML documentation using Redoc.

Transient JSON build files under computable/OAS are cleaned up by the scripts/Makefile after processing.

## Prerequisites

- Docker and docker-compose available locally.
- Host user mapping to UID/GID 1000 is recommended for volume permissions (default in development/docker-compose.yml).
  Adjust if your host differs.

You do **NOT** need local PHP or Node toolchains.

## Quick start

All Make targets are executed from the development directory. Below is a summary of the available targets and how to use them.

### General notes

- `SPEC` must be one of: `overview` `system` `ehr` `query` `definition` `demographic` `admin`
- `LANG` is any OpenAPI Generator language (see the LANGUAGES list in the Makefile).
- Targets run containers; outputs are written to the mounted working tree.

### Primary targets

- `help`
  Prints an overview of targets and usage.

- `install`
  Builds the php image and installs Composer dependencies in the container. Also runs composer dump-autoload.
  Example: `make install`

- `bundle SPEC=<spec>`
  Bundles a single specification end-to-end: bundles JSON, transforms into -codegen/-validation/-html YAMLs, renders HTML, then removes transient JSONs.
  Example: `make bundle SPEC=overview`

- `all` / `bundle-all`
  Iterates bundle over all specs. In the current Makefile this is exposed as the target `all`.
  Example: `make all`

### Alias bundle targets (short-hands)

- `overview`, `system`, `ehr`, `query`, `definition`, `demographic`, `admin`
  Each maps to `make bundle SPEC=<alias>`.
  Example: `make ehr`

### Validation

- `validate SPEC=<spec>`
  Runs redocly lint on authoring and built YAMLs and swagger-cli validate on the built YAMLs.
  Example: `make validate SPEC=query`

- `validate-all`
  Validates all specs.
  Example: `make validate-all`

### Mock servers

- `run SPEC=<spec>`
  Runs danielgtaylor/apisprout (port 8000) against the -validation YAML with request/server validation and watch.
  Example: `make run SPEC=definition`

- `run-mock SPEC=<spec>`
  Runs stoplight/prism:4 mock server (hosted at port 8000 mapped to container 4010) against the -validation YAML.
  Example: `make run-mock SPEC=overview`

### Code generation

- `generate SPEC=<spec> LANG=<lang>`
  Uses openapitools/openapi-generator-cli to generate client/server code into codegen/oas-<spec>/<lang>.
  Example: `make generate SPEC=ehr LANG=kotlin`

- `generate-all`
  Generates code for all specs across the predefined LANGUAGES in the Makefile.
  Example: `make generate-all`

### Housekeeping

- `clean`
  Removes transient JSONs under computable/OAS and clears codegen outputs.
  Example: `make clean`

- `composer ARGS="..."`
  Runs arbitrary composer commands inside the php container.
  Example: `make composer ARGS="update -W"`

## Typical workflows

1. First-time setup:
   ```bash
   cd development && make install
   ```

2. Build everything:
   ```bash
   cd development && make all
   ```

3. Build a single spec while editing:
   ```bash
   cd development && make overview
   ```

4. Validate a spec:
   ```bash
   cd development && make validate SPEC=system
   ```

5. Generate a client:
   ```bash
   cd development && make generate SPEC=ehr LANG=typescript-fetch
   ```

6. Run a quick mock server:
   ```bash
   cd development && make run SPEC=query
   ```

## Troubleshooting and tips

- **Permissions on Windows/WSL**: docker-compose.yml pins user 1000:1000; align your host UID/GID or adjust/remove the   mapping.
- **Out-of-memory**: Redocly is run with NODE_OPTIONS="--max-old-space-size=4048". Close other watchers if you hit OOM.
- After editing PHP Writer classes, re-run `docker-compose run --rm php composer dump-autoload`.
- Ensure you run make from the development directory (paths are relative there).